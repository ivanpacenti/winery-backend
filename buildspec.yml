version: 0.2
phases:
  install:
    runtime-versions:
      dotnet: 8.0
    commands:
      - echo "Restoring dependencies..."
      - dotnet restore
  build:
    commands:
      - echo "Building backend..."
      - dotnet publish -c Release -o published
  post_build:
    commands:
      - echo "Fetching SSH Key from Secrets Manager..."
      - aws secretsmanager get-secret-value --secret-id SSH_PRIVATE_KEY --query SecretString --output text > /root/.ssh/id_rsa
      - sed -i 's/\\n/\n/g' /root/.ssh/id_rsa
      - chmod 600 /root/.ssh/id_rsa
      - echo "Deploying backend to EC2..."
      - scp -o StrictHostKeyChecking=no -r published/* ec2-user@16.170.247.142:/var/www/backend/
      - echo "Restarting backend service..."
      - ssh ec2-user@16.170.247.142 "sudo systemctl restart backend.service"
      - echo "Finished deployment"
